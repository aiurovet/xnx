// Generate icons for this application using itself
// The file designed for runs primarily on Linux
// Requires: Google Chrome, ImageMagick's convert, png2icns as well as InkScape for Wine

{
  "rename": {
    "{{-cmd-}}": "{cmd}",
    "{{-cur-dir-}}": "{cur-dir}",
    "{{-can-expand-content-}}": "{can-expand-content}",
    "{{-detect-paths-}}": "{dtp}",
    "{{-expand-content-}}": "{expand-content}",
    "{{-exec-}}": "{run}",
    "{{-inp-}}": "{inp}",
    "{{-out-}}": "{out}",
    "{{-reset-}}": "{reset}",
    "{{-stop-}}": "{stop}", // stop immediately
    "{{-sub-}}": "{sub}"
  },
  "action": {
    "{{-if-}}": { "!=": [ "${WINE}", "" ], "{{-then-}}": {
      "{cmd}": "echo Creating icons under Wine is not supported",
      "{inp}": "",
      "{out}": "",
      "{stop}": null
    } },

    "{dtp}": "\\{[^\\{\\}\\-]+\\-(dir|path)\\}",
    "{prj}": "doul",

    "{{-import-}}": "../../examples/cmd.json",

    "{R}": [
      // Ensure directory structure matches expectations
      {
        "{cmd}": [
          // Remove possible remnants from the previous run
          "{sub} --delete out png svg",
          // Ensure temporary and the OS-specific output and icon directories are created
          "{sub} --mkdir png/core png/dark svg ../../bin/{OsType}/icons/core ../../bin/{OsType}/icons/dark"
        ],

        "{run}": null,
        "{reset}": null
      },
      {
        "{cmd}": "{chrome} --headless --default-background-color=0 --window-size={dim},{dim} --screenshot=\"{out}\" \"file://{inp}\"",
        "{can-expand-content}": true,
        "{dim-name}": "{icon-name}_{dim}x{dim}",
        "{svg-path}": "{cur-dir}/svg/{dim-name}.svg",

        "{inp}": "{prj}.svg",

        "{icon-data}": [
          { "{icon-fill}": "white", "{icon-stroke}": "black", "{look}": "core" },
          { "{icon-name}": "icon_{prj}", "{icon-fill}": "black", "{icon-stroke}": "white", "{look}": "dark" }
        ],

        "{icon-name}": "icon_{prj}_{look}",
        "{png-path}": "{cur-dir}/png/{look}/{dim-name}.png",

        "{param}": [
          { "{dim}":   16, "{scn-transform}":  "",               "{stroke-width}": "1",   "{drw-transform}": "translate(1,1)" },
          { "{dim}":   24, "{scn-transform}":  "scale(1.5,1.5)", "{stroke-width}": "1.5", "{drw-transform}": "translate(1.5,1.5)" },
          { "{dim}":   32, "{scn-transform}":  "scale(  2,  2)", "{stroke-width}": "1" },
          { "{dim}":   48, "{scn-transform}":  "scale(  3,  3)" },
          { "{dim}":   64, "{scn-transform}":  "scale(  4,  4)" },
          { "{dim}":   96, "{scn-transform}":  "scale(  6,  6)" },
          { "{dim}":  128, "{scn-transform}":  "scale(  8,  8)" },
          { "{dim}":  256, "{scn-transform}":  "scale( 16, 16)" },
          { "{dim}":  512, "{scn-transform}":  "scale( 32, 32)" },
          { "{dim}": 1024, "{scn-transform}":  "scale( 64, 64)" }
        ],

        "{out}": "{png-path}",

        "{{-reset-}}": null
      },
      {
        "{from-dir}": "{cur-dir}/png",
        "{icon-dir}": "../../bin/{OsType}/icons",
        "{icon-name}": "icon_{prj}_{look}",
        "{icon-pthp}": "{from-dir}/{look}/{icon-name}",

        "{look}": [ "core", "dark" ],

        "{{-if-}}" : { "==/i": [ "{OsType}", "Linux" ], "{{-then-}}": {
          "{cmd}": "{sub} --move \"{icon-pthp}_16x16.png\" \"{icon-pthp}_24x24.png\" \"{icon-pthp}_48x48.png\" \"{icon-pthp}_96x96.png\" \"{icon-dir}/{look}\""
        }, "{{-else-}}" : { "{{-if-}}" : { "==/i": [ "{OsType}", "macOS" ], "{{-then-}}": {
          "{cmd}": "iconutil -c icns -o \"{icon-dir}/{look}/{icon-name}.icns\" \"{from-dir}/{look}\""
        }, "{{-else-}}" : { "{{-if-}}" : { "==/i": [ "{OsType}", "Windows" ], "{{-then-}}": {
          "{cmd}": "{convert} +antialias \"{icon-pthp}_16x16.png\" \"{icon-pthp}_24x24.png\" \"{icon-pthp}_32x32.png\" \"{icon-pthp}_48x48.png\" \"{icon-pthp}_256x256.png\" \"{icon-dir}/{look}/{icon-name}.ico\""
        } } } } } },

        "{run}": null
      },

      {
        "{cmd}": "{sub} --delete png svg",
        "{run}": null
      }
    ]
  }
}

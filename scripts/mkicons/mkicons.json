// Generate icons for this application using itself
// The file designed for runs primarily on Linux
// Requires: Google Chrome, ImageMagick's convert, png2icns as well as InkScape for Wine

{
  "x": {
    "rename": {
      "{{-cmd-}}": "{zmd}",
      "{{-cur-dir-}}": "{CD}",
      "{{-can-expand-content-}}": "{CEC}",
      "{{-detect-paths-}}": "{dtp}",
      "{{-reset-}}": "{reset}",
      "{{-inp-}}": "{inp}",
      "{{-out-}}": "{out}"
    },
    "action": [
      { "{dtp}": "\\{[^\\{\\}\\-]+\\-(dir|path)\\}" }, // regular expression

      { "{zmd}": [
        "sub --delete out png svg",
        "sub --mkdir out/linux out/macos out/windows png svg'"
      ] },

      { "{reset}": null },

      {
        "{{-if-}}": { "!=": [ "${WINE}", "" ], "{{-then-}}": {
          // WINE environment variable is set
          "{svg2png}": "\"C:\\Program Files\\Inkscape\\inkscape.exe\" -z -e \"{out}\" -w {dim} -h {dim} \"{svg-path}\""
        }, "{{-else-}}": {
          // WINE environment variable is not set
          "{svg2png}": "chrome --headless --default-background-color=0 --window-size={dim},{dim} --screenshot=\"{out}\" \"file://{svg-path}\""
        }
      } },

      {
        "{CEC}": true,
        "{zmd}": [
          "expand-content \"{inp}\" \"{svg-path}\"",
          "{svg2png}"
        ],
        "{dim-name}": "{icon-name}_{dim}x{dim}",
        "{png-path}": "{CD}/png/{dim-name}.png",
        "{svg-path}": "{CD}/svg/{dim-name}.svg"
      },

      {
        "{prj}": "doul",
        "{inp}": "{prj}.svg",
        "{icon}": [
          { "{icon-name}": "{prj}",      "{icon-fill}": "white", "{icon-stroke}": "black" },
          { "{icon-name}": "{prj}_dark", "{icon-fill}": "black", "{icon-stroke}": "white" }
        ]
      },

      {
        "{param}": [
          {
            "{dim}": 16,
            "{scn-transform}":  "",
            "{drw-transform}":   "translate(1,1)", "{stroke-width}": "1",
            "{chr-d-transform}": "translate(0,0)", "{chr-d-path}":  "M5,0 L5,6 L0,6 L0,2 L5,2",
            "{chr-o-transform}": "translate(3,4)", "{chr-o-path}":  "M0,0 L0,4 L5,4 L5,0 L0,0",
            "{chr-u-transform}": "translate(6,6)", "{chr-u-path}":  "M0,0 L0,4 L5,4 L5,0",
            "{chr-l-transform}": "translate(9,8)", "{chr-l-path}":  "M0,0 L0,5 L4,5",
            "{out}": "{png-path}"
          },

          { "{dim}":   24, "{scn-transform}":  "scale(1.5,1.5)", "{stroke-width}": "1.5", "{drw-transform}":  "translate(1.5,1.5)", "{out}": "{png-path}" },
          { "{dim}":   32, "{scn-transform}":  "scale(  2,  2)", "{stroke-width}": "1", "{out}": "{png-path}" },
          { "{dim}":   48, "{scn-transform}":  "scale(  3,  3)", "{out}": "{png-path}" },
          { "{dim}":   64, "{scn-transform}":  "scale(  4,  4)", "{out}": "{png-path}" },
          { "{dim}":   96, "{scn-transform}":  "scale(  6,  6)", "{out}": "{png-path}" },
          { "{dim}":  128, "{scn-transform}":  "scale(  8,  8)", "{out}": "{png-path}" },
          { "{dim}":  256, "{scn-transform}":  "scale( 16, 16)", "{out}": "{png-path}" },
          { "{dim}":  512, "{scn-transform}":  "scale( 32, 32)", "{out}": "{png-path}" },
          { "{dim}": 1024, "{scn-transform}":  "scale( 64, 64)", "{out}": "{png-path}" }
        ]
      },

      {
        "{reset}": null,
        "{dtp}": "\\{out|\\{png\\}", // repeat after reset
        "{prj}": "doul"
      },

      {
        "{zmd}": [
          "sleep 0.5s",
          "sub --copy \"{png}_16x16.png\" \"{png}_24x24.png\" \"{png}_48x48.png\" \"{png}_96x96.png\" \"{out-lnx}\"",
          "sub --copy \"{png}_dark_16x16.png\" \"{png}_dark_24x24.png\" \"{png}_dark_48x48.png\" \"{png}_dark_96x96.png\" \"{out-lnx}\"",
          "png2icns \"{out-mac}.icns\" \"{png}_16x16.png\" \"{png}_32x32.png\" \"{png}_128x128.png\" \"{png}_256x256.png\" \"{png}_512x512.png\" \"{png}_1024x1024.png\"",
          "png2icns \"{out-mac}_dark.icns\" \"{png}_dark_16x16.png\" \"{png}_dark_32x32.png\" \"{png}_dark_128x128.png\" \"{png}_dark_256x256.png\" \"{png}_dark_512x512.png\" \"{png}_dark_1024x1024.png\"",
          "convert +antialias \"{png}_16x16.png\" \"{png}_24x24.png\" \"{png}_32x32.png\" \"{png}_48x48.png\" \"{png}_256x256.png\" \"{out-win}.ico\"",
          "convert +antialias \"{png}_dark_16x16.png\" \"{png}_dark_24x24.png\" \"{png}_dark_32x32.png\" \"{png}_dark_48x48.png\" \"{png}_dark_256x256.png\" \"{out-win}_dark.ico\""
        ],
        "{png}": "png\\{prj}",
        "{out-lnx}": "out\\linux",
        "{out-mac}": "out\\macos\\{prj}",
        "{out-win}": "out\\windows\\{prj}"
      },

      { "{reset}": null },

      { "{zmd}": "sub --delete png svg" }
    ]
  }
}

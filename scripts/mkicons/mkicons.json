// Generate icons for this application using itself
// The file designed for runs primarily on Linux
// Requires: Google Chrome, ImageMagick's convert, png2icns as well as InkScape for Wine

{
  "{{-aliases-}}": {
    "{{-cmd-}}": "{cmd}",
    "{{-cur-dir-}}": "{cur-dir}",
    "{{-can-expand-content-}}": "{can-expand-content}",
    "{{-detect-paths-}}": "{dtp}",
    "{{-drop-}}": "{drop}",
    "{{-expand-content-}}": "{expand-content}",
    "{{-inp-}}": "{inp}",
    "{{-next-}}": "{next}",
    "{{-out-}}": "{out}",
    "{{-run-}}": "{run}",
    "{{-stop-}}": "{stop}", // stop immediately
    "{{-sub-}}": "{sub}"
  },

  "{{-if-}}": { "!=": [ "${WINE}", "" ], "{{-then-}}": {
    // Chrome under Wine is out of date, ImageMagick and Inkscape are unable to process
    "{run}": "cmd /c echo Creating app icons under Wine is disabled",
    "{next}": null
    //"{svg2png}": "inkscape -z -o \\\"{out}\\\" -w {dim} -h {dim} \\\"{inp}\\\""
    //"{svg2png}": "{convert} \"{inp}\" \"{out}\""
  }, "{{-else-}}": {
    // Do not enclose the output path in quotes, as this will not work, hence avoid spaces (existing bug in Chromium)
    "{svg2png}": "{chrome} --headless --default-background-color=0 --window-size={dim},{dim} --screenshot={out} \"file://{inp}\""
  } },

  "{dtp}": "\\{[^\\{\\}\\-]+\\-(dir|path|pthp)\\}",
  "{prj}": "doul",

  "{{-import-}}": "../../examples/cmd.json",

  "{bin-os-dir}": "../../bin/{OsType}",
  "{icon-dir}": "{bin-os-dir}",

  "if2": [{
    "{{-if-}}" : { "==/i": [ "{OsType}", "Linux" ], "{{-then-}}": {
      "{icon-dir}": "{bin-os-dir}/icons"
    } }
  }],

  "{R}": [
    // Ensure directory structure matches expectations
    {
      "{run}": [
        // Remove possible remnants from the previous run
        "{sub} --delete out png svg",
        // Ensure temporary and the OS-specific output and icon directories are created
        "{sub} --mkdir png/lite png/dark svg \"{icon-dir}\""
      ]
    },

    {
      "{drop}": "{run}",

      "{can-expand-content}": true,

      "{icon-data}": [
        { "{icon-fill}": "white", "{icon-stroke}": "black", "{look}": "lite" },
        { "{icon-fill}": "black", "{icon-stroke}": "white", "{look}": "dark" }
      ],

      "{param}": [
        { "{dim}":   16, "{scn-transform}":  "",               "{stroke-width}": "1",   "{drw-transform}": "translate(1,1)" },
        { "{dim}":   24, "{scn-transform}":  "scale(1.5,1.5)", "{stroke-width}": "1.5", "{drw-transform}": "translate(1.5,1.5)" },
        { "{dim}":   32, "{scn-transform}":  "scale(  2,  2)", "{stroke-width}": "1" },
        { "{dim}":   48, "{scn-transform}":  "scale(  3,  3)" },
        { "{dim}":   64, "{scn-transform}":  "scale(  4,  4)" },
        { "{dim}":   96, "{scn-transform}":  "scale(  6,  6)" },
        { "{dim}":  128, "{scn-transform}":  "scale(  8,  8)" },
        { "{dim}":  256, "{scn-transform}":  "scale( 16, 16)" },
        { "{dim}":  512, "{scn-transform}":  "scale( 32, 32)" },
        { "{dim}": 1024, "{scn-transform}":  "scale( 64, 64)" }
      ],

      "{inp}": "{cur-dir}/{prj}.svg",
      "{out}": "{cur-dir}/png/{look}/{prj}_{look}_{dim}x{dim}.png",
      "{cmd}": "{svg2png}"
    },

    {
      "{drop}": [ "{icon-data}", "{param}" ],

      "{look-dir}": "{cur-dir}/png/{look}",
      "{icon-name}": "{prj}_{look}",
      "{icon-pthp}": "{look-dir}/{icon-name}",

      "{look}": [ "lite", "dark" ],
      "{exe-pthp}": "{bin-os-dir}\\{prj}",

      "{{-if-}}" : { "==/i": [ "{OsType}", "Linux" ], "{{-then-}}": {
        "{run}": [
          //"png2icns \"{icon-dir}/{look}/{icon-name}.icns\" \"{look-dir}/{icon-name}_16x16.png\" \"{look-dir}/{icon-name}_32x32.png\" \"{look-dir}/{icon-name}_128x128.png\" \"{look-dir}/{icon-name}_256x256.png\" \"{look-dir}/{icon-name}_512x512.png\" \"{look-dir}/{icon-name}_1024x1024.png\"",
          //"{convert} +antialias \"{icon-pthp}_16x16.png\" \"{icon-pthp}_24x24.png\" \"{icon-pthp}_32x32.png\" \"{icon-pthp}_48x48.png\" \"{icon-pthp}_256x256.png\" \"{exe-pthp}_{look}.ico\"",
          "{sub} --move \"{icon-pthp}_16x16.png\" \"{icon-pthp}_24x24.png\" \"{icon-pthp}_48x48.png\" \"{icon-pthp}_96x96.png\" \"{icon-dir}\""
        ]
      }, "{{-else-}}" : { "{{-if-}}" : { "==/i": [ "{OsType}", "macOS" ], "{{-then-}}": {
        "{look-dir-mac}": "{look-dir}.iconset",
        "{run}": [
          "cp -p \"{icon-pthp}_32x32.png\" \"{look-dir}/icon_16x16@2x.png\"",
          "mv -f \"{icon-pthp}_64x64.png\" \"{look-dir}/icon_32x32@2x.png\"",
          "cp -p \"{icon-pthp}_256x256.png\" \"{look-dir}/icon_128x128@2x.png\"",
          "cp -p \"{icon-pthp}_512x512.png\" \"{look-dir}/icon_256x256@2x.png\"",
          "mv -f \"{icon-pthp}_1024x1024.png\" \"{look-dir}/icon_512x512@2x.png\"",
          "mv -f \"{icon-pthp}_16x16.png\" \"{look-dir}/icon_16x16.png\"",
          "mv -f \"{icon-pthp}_32x32.png\" \"{look-dir}/icon_32x32.png\"",
          "mv -f \"{icon-pthp}_128x128.png\" \"{look-dir}/icon_128x128.png\"",
          "mv -f \"{icon-pthp}_256x256.png\" \"{look-dir}/icon_256x256.png\"",
          "mv -f \"{icon-pthp}_512x512.png\" \"{look-dir}/icon_512x512.png\"",
          "rm -f \"{icon-pthp}_24x24.png\" \"{icon-pthp}_48x48.png\" \"{icon-pthp}_96x96.png\"",

          "{shell} 'mv -f \"{look-dir}\" \"{look-dir-mac}\" && iconutil --convert icns -o \"{icon-dir}/{look}/{icon-name}.icns\" \"{look-dir-mac}\"'"
        ]
      }, "{{-else-}}" : { "{{-if-}}" : { "==/i": [ "{OsType}", "Windows" ], "{{-then-}}": {
        "{run}": [
          "{convert} +antialias \"{icon-pthp}_16x16.png\" \"{icon-pthp}_24x24.png\" \"{icon-pthp}_32x32.png\" \"{icon-pthp}_48x48.png\" \"{icon-pthp}_256x256.png\" \"{bin-os-dir}\\{icon-name}.ico\"",
          "\"${ProgramFiles}\\nodejs\\npm.cmd\" install rcedit",
          "{cur-dir}\\node_modules\\rcedit\\bin\\rcedit-x64.exe \"{exe-pthp}.exe\" --set-icon \"{exe-pthp}_{look}.ico\"",
          "{shell} '{delete} \"{exe-pthp}.ico\"'"
        ]
      } } } } } }
    },

    {
      "{drop}": "{look}",

      "{run}": "{sub} --delete png svg"
    }
  ]
}
